---
title: "regression_seine"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=objects())
###############packages
library(dygraphs)
library(xts)
library(MASS)
library(caret)

library(data.table)
library(tidyverse)
library(lubridate)
rmse<-function(eps)
{
	return(round(sqrt(mean(eps^2,na.rm=TRUE)),digits=0))
}

mape<-function(y,ychap)
{
	return(round(100*mean(abs(y-ychap)/abs(y)),digits=2))
}

```

Note that the `echo = FALSE` parameter was added to the code chunk to
prevent printing of the R code that generated the plot.

```{r}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = dirname(rstudioapi::getActiveDocumentContext()$path))
knitr::opts_knit$set(root.dir = "../Data/Extraction_Hydro/Seine")
```

Deux tâches en gros: 1. prédiction individuelle d'une seulement station,
basé sur les données de dix ans. 2. modèle global de tous les stations
sur la Seine, ou même sur tous les fleuves.

## 1.prédiction individuelle d'une seulement station

Prenons la station H1700010: La Seine à Pont-sur-Seine covariables: les
dépits d'eau en amont et les météo, avant certain temps.

paramètres météo: "'''Parameter(s):\n", "T2M MERRA-2 Temperature at 2
Meters (C) \n", "T2MDEW MERRA-2 Dew/Frost Point at 2 Meters (C)\n",
"T2MWET MERRA-2 Wet Bulb Temperature at 2 Meters (C) \n", "QV2M MERRA-2
Specific Humidity at 2 Meters (g/kg) \n", "RH2M MERRA-2 Relative
Humidity at 2 Meters (%) \n", "PRECTOTCORR MERRA-2 Precipitation
Corrected (mm/hour) '''\n"

```{r}
tableau_stations <- read.delim("../Data/Seine/Stations_2019.csv",encoding = "UTF-8", sep=";", header = TRUE)


```

Meteo d'un endroit

```{r}
alsace_meteo = read_delim("../Data/meteo/Alsace Champagne-Ardenne Lorraine.csv")
plot(alsace_meteo$PRECTOTCORR[7200:7920], pch=20)
#plot(abs(fft(alsace_meteo$PRECTOTCORR, inverse = FALSE)))
```

### 1.1 Méthode de Fourier

```{r}
data_files <- list.files("../Data/Extraction_Hydro/Seine")  # Identify file names
pont_list <- data_files[grepl("H1700010", data_files)][1:10]
pont_list
pont <- lapply(paste0("../Data/Extraction_Hydro/Seine/",pont_list), read.csv2)
pont <- rbindlist(pont)
pont <- as_tibble(pont)
names(pont) <- c("date","debit","validite")
pont$date <- as.POSIXct(pont$date, format = "%d/%m/%Y %H:%M")
pont$jour <- as.integer(format(pont$date, format="%d"))
pont$mois <- as.integer(format(pont$date, format="%m"))
pont$annee <- as.integer(format(pont$date, format="%y"))
pont$debit <- as.numeric(pont$debit)
pont <- as.data.frame(pont)
pont$index_period <- matrix(1:4380,nrow=nrow(pont),ncol=1)
```

```{r}
lm0<-lm(debit~annee,data=pont)
debit.detrend<-pont$debit-lm0$fitted
summary(lm0)
attach(pont)
plot(debit, type='l')

plot(abs(fft(debit, inverse = FALSE)))

#####################création de la base de fourier
w<-2*pi/4380
Nfourier<-20
for(i in c(1:Nfourier))
{
	assign(paste("cos", i, sep=""),cos(w*(index_period)*i))
	assign(paste("sin", i, sep=""),sin(w*(index_period)*i))
}

objects()

plot(cos1,type='l')
plot(cos10,type='l')
```

```{r}
#####################insertion de la base de fourier dans la data.frame

cos<-paste('cos',c(1:Nfourier),sep="",collapse=",")                         
sin<-paste('sin',c(1:Nfourier),sep="",collapse=",")
paste("data.frame(pont,",cos,",",sin,")",sep="")

####le but du code suivant est d'exécuter l'instruction:
####pont<-data.frame(pont,cos1,cos2,cos3,cos4,cos5,cos6,cos7,cos8,cos9,cos10,sin1,sin2,sin3,
#sin4,sin5,sin6,sin7,sin8,sin9,sin10)

#pont<-data.frame(pont,cos1,cos2,cos3,cos4,cos5,cos6,cos7,cos8,cos9,cos10,sin1,sin2,sin3,sin4,sin5,sin6,sin7,sin8,sin9,sin10)

pont<-eval(parse(text=paste("data.frame(pont,",cos,",",sin,")",sep="")))
names(pont)
###ne marche pas:
###eval(paste("data.frame(pont,",cos,",",sin,")",sep=""))

names(pont)

lm.fourier<-list()
eq<-list()
for(i in c(1:Nfourier))
{
	cos<-paste(c('cos'),c(1:i),sep="")
	sin<-paste(c('sin'),c(1:i),sep="")
	fourier<-paste(c(cos,sin),collapse="+")
	eq[[i]]<-as.formula(paste("debit.detrend~",fourier,sep=""))
	lm.fourier[[i]]<-lm(eq[[i]],data=pont)
}

length(lm.fourier)

lapply(lm.fourier, summary)



###2 syntaxes pour lapply
#
adjR<-function(x)
{
	summary(x)$adj.r.squared
}

unlist(lapply(lm.fourier,adjR))

#
adjR<-unlist(lapply(lm.fourier,function(x){summary(x)$adj.r.squared}))

plot(adjR,type='b',pch=20,xlab='K',ylab='adjusted R-squared')
points(5,adjR[5],col='red',pch=20,cex=2)

par(mfrow=c(1,2))
plot(pont$debit.detrend,type='l', lwd=2)
lines(lm.fourier[[20]]$fitted,col='red', lwd=2)
par(mfrow=c(1,1))
plot(pont$debit.detrend,type='l', lwd=2)
lines(lm.fourier[[5]]$fitted,col='red', lwd=2)


plot(pont$debit.detrend[1:52],type='l', lwd=2)
lines(lm.fourier[[20]]$fitted[1:52],col='red', lwd=2)

lines(lm.fourier[[5]]$fitted[1:52],col='red', lwd=2)

```

La méthode Fourier n'est pas applicable ici. On voit que R2 ajusté est
seulement 0.2

Il faut choisir une série temporelle stationnaire si on veut vraiment
utiliser Fourier...

### 1.2 GAM

On

```{r}

meteo <- read.csv2("../Data/meteo/  (1).csv", sep=";", encoding = "UTF-8")
meteo <- meteo[, c("ID.OMM.station","Date", "Température", "Précipitations.dans.la.dernière.heure", "Précipitations.dans.les.3.dernières.heures") ] 
meteo <- separate(meteo, col = Date, into = c("Datetime", "timezone"), sep = "\\+")
meteo <- separate(data = meteo, col = Datetime, into = c("Date", "Time"), sep = "T")
meteo <- as_tibble(meteo)
#pont$jour <- as.integer(format(pont$date, format="%d"))
#pont$mois <- as.integer(format(pont$date, format="%m"))
#pont$annee <- as.integer(format(pont$date, format="%y"))

#meteo[order(as.Date(meteo$Date, format="%Y-%M-%D"), as.Date(meteo$Time, format="%H:%M:%S")),]
meteo$Date <- ymd(meteo$Date)
meteo$Time <- hms(meteo$Time)
meteo <-arrange(meteo, Date, Time)

```
